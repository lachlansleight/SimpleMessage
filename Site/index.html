<!doctype html>
<html class="no-js" lang="">

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<title></title>
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link rel="manifest" href="site.webmanifest">
	<link rel="apple-touch-icon" href="icon.png">
	<!-- Place favicon.ico in the root directory -->

	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/main.css">
</head>

<body>
	<!--[if lte IE 9]>
		<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
	<![endif]-->

	
	<div id="Header">
		<h1 id="MessageTitle">Loading Room...</h1>
		<h1 id="AuthenticationTitle">Simple Message</h1>
		<h1 id="LobbyTitle">Choose Room</h1>
	</div>

	<div id="Main">
		<div id="AuthenticationMain">
			<div id="AuthenticationWelcome">
				<button type="button" onClick="GotoLogin();" id="LoginButton">Login</button>
				<button type="button" onClick="GotoRegister();" id="RegisterButton">Register</button>
			</div>
			<div id="AuthenticationLogin">
				<button type="button" onClick="GotoWelcome();" id="LoginBackButton">Back</button>
				<p>Email</p>
				<input type="text" name="LoginEmail" id="LoginEmailInput" />
				<p>Password</p>
				<input type="password" name="LoginPassword" id="LoginPasswordInput"/>
				<button type="button" onClick="Login();" id="LoginButton">Login</button>
				<p id="LoginError"></p>
			</div>
			<div id="AuthenticationRegister">
				<button type="button" onClick="GotoWelcome();" id="RegisterBackButton">Back</button>
				<p>Display Name</p>
				<input type="text" name="RegisterName" id="RegisterDisplayNameInput"/>
				<p>Email</p>
				<input type="text" name="RegisterEmail" id="RegisterEmailInput"/>
				<p>Password</p>
				<input type="password" name="RegisterPassword" id="RegisterPasswordInput" />
				<button type="button" onClick="Register();" id="RegisterButton">Register</button>
				<p id="RegisterError"></p>
			</div>
		</div>
		<div id="LobbyMain">
			<div id="LobbyWelcome">
				<button type="button" onClick="GotoCreate();" id="LoginButton">Create Room</button>
				<button type="button" onClick="GotoJoin();" id="RegisterButton">Join Room</button>
			</div>
			<div id="LobbyCreate">
				<button type="button" onClick="GotoLobbyWelcome();" id="CreateBackButton">Back</button>
				<p>Room name</p>
				<input type="text" name="CreateName" id="CreateNameInput" />
				<p>Partner's Email</p>
				<input type="text" name="CreateEmail" id="CreateEmailInput" />
				<button type="button" onClick="CreateRoom();" id="CreateButton">Create</button>
				<p id="CreateError"></p>
			</div>
			<div id="LobbyJoin">
				<button type="button" onClick="GotoLobbyWelcome();" id="JoinBackButton">Back</button>
				<p>Room name</p>
				<input type="text" name="JoinName" id="JoinNameInput" />
				<button type="button" onClick="JoinRoom();" id="JoinButton">Join</button>
				<p id="JoinError"></p>
			</div>
		</div>
		<div id="MessageMain">
		<!--
		<div class="Message">
			<p class="MessageSender">Lachlan<span class="MessageTime">7:30am</span></p>
			<p class="MessageBody">I think that this messaging platform is just completely and totally awful. I love it! :D</p>
		</div>
		<div class="Message">
			<p class="MessageSender">Definitely not Lachlan<span class="MessageTime">7:30am</span></p>
			<p class="MessageBody">I think you're an idiot.</p>
		</div>
		-->
		</div>
	</div>

	<div id="MessageSend">
		<button type="button" onClick="PushMessage();" id="MessageSendButton">Send</button>
		<span id="InputFieldParent"><input type="text" name="MessageInput" id="MessageInputField"/></span>
	</div>

	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.1/firebase-database.js"></script>
	<script>
	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyAcM-x78un217qadKIzFxHL1c7ObfamE1A",
		authDomain: "ls-simplemessage.firebaseapp.com",
		databaseURL: "https://ls-simplemessage.firebaseio.com",
		projectId: "ls-simplemessage",
		storageBucket: "ls-simplemessage.appspot.com",
		messagingSenderId: "591459814121"
	};
	firebase.initializeApp(config);

	var database = firebase.database();
	var auth = firebase.auth();
	var messageRef = null;
	
	auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
	auth.onAuthStateChanged(function(user) {
		if(user) {
			currentUser = user;
		} else {
			//handle sign-out
			currentUser = null;
		}
	});

	var currentUser = auth.currentUser;

	if(currentUser) {
		document.getElementById("AuthenticationMain").hidden = true;
		document.getElementById("AuthenticationTitle").hidden = true;
		document.getElementById("LobbyMain").hidden = false;
		document.getElementById("LobbyTitle").hidden = false;
		document.getElementById("MessageMain").hidden = true;
		document.getElementById("MessageTitle").hidden = true;
		console.log("Logged in as: \n" + JSON.stringify(currentUser, null, 4));
	} else {
		document.getElementById("AuthenticationMain").hidden = false;
		document.getElementById("AuthenticationTitle").hidden = false;
		document.getElementById("LobbyMain").hidden = true;
		document.getElementById("LobbyTitle").hidden = true;
		document.getElementById("MessageMain").hidden = true;
		document.getElementById("MessageTitle").hidden = true;
		console.log("Not logged in");
	}

	if(currentRoom) {

	}
	GotoWelcome();
	GotoLobbyWelcome();

	var currentRoom = null;

	var displayedMessages = [];
	var Messages = [];

	
	function CreateRoom() {
		document.getElementById("CreateError").textContent = "";

		var roomName = document.getElementById("CreateNameInput").value;
		var email = document.getElementById("CreateEmailInput").value;
		database.ref("rooms/" + roomName).once('value').then(function(snapshot) {
			if(snapshot.exists()) {
				document.getElementById("CreateError").textContent = "Room already exists";
			} else {
				database.ref("rooms/" + roomName).set({
					creator : currentUser.email,
					partner : email
				}).then(function() {
					console.log("created room with name " + roomName);
					var newRoom = {
						creator : currentUser.email,
						partner : email
					}
					InitializeRoom(newRoom, roomName);
					document.getElementById("LobbyMain").hidden = true;
					document.getElementById("LobbyTitle").hidden = true;
					document.getElementById("MessageMain").hidden = false;
					document.getElementById("MessageTitle").hidden = false;
				});
			}
		});
	}

	function JoinRoom() {
		document.getElementById("JoinError").textContent = "";

		var roomName = document.getElementById("JoinNameInput").value;
		database.ref("rooms/" + roomName).once('value').then(function(snapshot) {
			if(!snapshot.exists()) {
				document.getElementById("JoinError").textContent = "Room does not exist";
			} else {
				var data = snapshot.val();
				console.log(JSON.stringify(data, null, 4));
				if(data["creator"] != currentUser.email && data["partner"] != currentUser.email) {
					document.getElementById("JoinError").textContent = "You are not authorized to join that room";
				} else {
					console.log("Joining room named " + snapshot.key);
					InitializeRoom(data, snapshot.key);
					document.getElementById("LobbyMain").hidden = true;
					document.getElementById("LobbyTitle").hidden = true;
					document.getElementById("MessageMain").hidden = false;
					document.getElementById("MessageTitle").hidden = false;
				}
			}
		});
	}

	function InitializeRoom(newRoom, key) {
		newRoom.name = key;
		if(currentRoom) {
			messageRef = database.ref("rooms/" + currentRoom.name + "/messages");
			messageRef.off('child_changed');
			messageRef.off('child_removed');
			messageRef.off('child_added');
		}

		currentRoom = newRoom;

		messageRef = database.ref("rooms/" + currentRoom.name + "/messages");
		console.log("Created messageref at rooms/" + currentRoom.name + "/messages");

		document.getElementById("MessageTitle").textContent = "Room: " + currentRoom.name;
		messageRef.on('child_added', function(snapshot, prevkey) {
			var data = snapshot.val();
			var key = snapshot.key;
			console.log("Child added: " + key);
			console.log(JSON.stringify(data, null, 4));

			if(!displayedMessages[key]) {
				HandleNewMessage(key, data);
				displayedMessages[key] = true;
				Messages.push({
					id: key,
					value: data
				});
			}
		});
		messageRef.on('child_changed', function(snapshot, prevkey) {
			var data = snapshot.val();
			var key = snapshot.key;
			console.log("Child changed: " + key);
			console.log(JSON.stringify(data, null, 4));

			UpdateMessage(key, data);
			for(var i = 0; i < Messages.length; i++) {
				if(Messages[i]["id"] == key) Messages[i]["value"] = data;
			}
		});
		messageRef.on('child_removed', function(snapshot) {
			var data = snapshot.val();
			var key = snapshot.key;
			console.log("Child removed: " + key);
			console.log(JSON.stringify(data, null, 4));

			RemoveMessage(key, data);
			for(var i = 0; i < Messages.length; i++) {
				if(Messages[i]["id"] == key) Messages.splice(i, 1);
			}
			displayedMessages.splice(displayedMessages.indexOf(key), 1);
		});
	}
	
	function HandleNewMessage(key, data) {
		console.log(JSON.stringify(data, null, 4));
		var main = document.getElementById("MessageMain");
		var newMessageDiv = document.createElement("div");
		newMessageDiv.className = "Message";
		if(data["sender"] == currentUser.email) newMessageDiv.className += " FromMe";
		else newMessageDiv.className += " FromThem";
		newMessageDiv.id = key;

		var newMessageSender = document.createElement("p");
		newMessageSender.className = "MessageSender";
		var senderNameText = document.createTextNode(data["senderName"]);
		newMessageSender.appendChild(senderNameText);

		var messageTime = document.createElement("span");
		messageTime.className = "MessageTime";
		var date = new Date(data["time"]);
		var messageTimeText = document.createTextNode(getPrettyTime(date));
		messageTime.appendChild(messageTimeText);
		newMessageSender.appendChild(messageTime);

		var messageBody = document.createElement("p");
		messageBody.className = "MessageBody";
		messageBody.innerHTML = data["content"];

		newMessageDiv.appendChild(newMessageSender);
		newMessageDiv.appendChild(messageBody);
		main.appendChild(newMessageDiv);

		window.scrollTo(0, document.body.scrollHeight);
	}

	function Register()	{
		document.getElementById("RegisterError").textContent = "";

		var displayName = document.getElementById("RegisterDisplayNameInput").value;
		var email = document.getElementById("RegisterEmailInput").value;
		var password = document.getElementById("RegisterPasswordInput").value;

		console.log("Attempting login with " + displayName + "/" + email + "/" + password);

		auth.createUserWithEmailAndPassword(email, password).then(function(user) {
			auth.currentUser.updateProfile({displayName: displayName});
		}).then(function() {
			console.log("Register success! User display name is " + currentUser.displayName + "/" + currentUser.email);
			document.getElementById("AuthenticationMain").hidden = true;
			document.getElementById("AuthenticationTitle").hidden = true;
			document.getElementById("LobbyMain").hidden = false;
			document.getElementById("LobbyTitle").hidden = false;
			document.getElementById("MessageMain").hidden = true;
			document.getElementById("MessageTitle").hidden = true;
		}).catch(function(error) {
			document.getElementById("RegisterError").textContent = error.message + "(" + error.code + ")";
		})
	}

	function Login() {
		var email = document.getElementById("LoginEmailInput").value;
		var password = document.getElementById("LoginPasswordInput").value;

		auth.signInWithEmailAndPassword(email, password).then(function(user) {
			console.log("Login success! User display name is " + currentUser.displayName + "/" + currentUser.email);
			document.getElementById("AuthenticationMain").hidden = true;
			document.getElementById("AuthenticationTitle").hidden = true;
			document.getElementById("LobbyMain").hidden = false;
			document.getElementById("LobbyTitle").hidden = false;
			document.getElementById("MessageMain").hidden = true;
			document.getElementById("MessageTitle").hidden = true;
		}).catch(function(error) {
			document.getElementById("LoginError").textContent = error.message + "(" + error.code + ")";
		});
	}

	function GotoLogin()
	{
		document.getElementById("AuthenticationWelcome").hidden = true;
		document.getElementById("AuthenticationLogin").hidden = false;
		document.getElementById("AuthenticationRegister").hidden = true;
	}

	function GotoRegister()
	{
		document.getElementById("AuthenticationWelcome").hidden = true;
		document.getElementById("AuthenticationLogin").hidden = true;
		document.getElementById("AuthenticationRegister").hidden = false;
	}

	function GotoWelcome()
	{
		document.getElementById("AuthenticationWelcome").hidden = false;
		document.getElementById("AuthenticationLogin").hidden = true;
		document.getElementById("AuthenticationRegister").hidden = true;
	}

	function GotoJoin()
	{
		document.getElementById("LobbyWelcome").hidden = true;
		document.getElementById("LobbyJoin").hidden = false;
		document.getElementById("LobbyCreate").hidden = true;
	}

	function GotoCreate()
	{
		document.getElementById("LobbyWelcome").hidden = true;
		document.getElementById("LobbyJoin").hidden = true;
		document.getElementById("LobbyCreate").hidden = false;
	}

	function GotoLobbyWelcome()
	{
		document.getElementById("LobbyWelcome").hidden = false;
		document.getElementById("LobbyJoin").hidden = true;
		document.getElementById("LobbyCreate").hidden = true;
	}



	function UpdateMessage(key, data) {
		var message = document.getElementById(key);
		message.childNodes[1].innerHTML = data["content"];
		window.scrollTo(0, document.body.scrollHeight);
	}

	function RemoveMessage(key, data) {
		var removeTarget = document.getElementById(key);
		removeTarget.parentNode.removeChild(removeTarget);
	}

	function PushMessage() {
		if(!document.getElementById("MessageInputField").value) return;

		console.log(JSON.stringify(messageRef, null, 4));

		//three cases:
		//0. user has no messages, so just push it
		//1. user has a message which hasn't been responded to (i.e. most recent message is theirs),
		//   in which case should append new content and update time
		//2. user has a message which has been responded to (i.e. most recent message is NOT theirs), 
		//   in which case should remove their last message and then just push

		var messageCase = 0;
		var lastMessage = Messages[Messages.length - 1];
		var currentDate = new Date();
		if(Messages.length == 0) messageCase = 0;
		else if(lastMessage["value"]["sender"] == currentUser.email) messageCase = 1;
		else if(lastMessage["value"]["sender"] != currentUser.email) messageCase = 2;

		console.log("Message case: " + messageCase);

		if(messageCase == 0) {
			var newid = messageRef.push();
			newid.set({
				time: currentDate.getTime(),
				sender: currentUser.email,
				senderName: currentUser.displayName,
				content: document.getElementById("MessageInputField").value
			});
		} else if(messageCase == 1) {
			var lastMessageRef = messageRef.child(lastMessage["id"]);
			var append = "<br><hr>" + document.getElementById("MessageInputField").value;
			lastMessageRef.update({
				time: currentDate.getTime(),
				content: lastMessage["value"]["content"] + append
			});
		} else if(messageCase == 2) {
			if(Messages.length > 1) {
				var secondLastMessageRef = messageRef.child(Messages[Messages.length - 2]["id"]);
				secondLastMessageRef.remove();
			}

			var newid = messageRef.push();
			newid.set({
				time: currentDate.getTime(),
				sender: currentUser.email,
				senderName: currentUser.displayName,
				content: document.getElementById("MessageInputField").value
			});
		}

		document.getElementById("MessageInputField").value = "";
	}

	function getQueryVariable(variable)	{
		var query = window.location.search.substring(1);
		var vars = query.split("&");
		for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
				if(pair[0] == variable){return pair[1];}
		}
		return(false);
	}

	function getPrettyTime(date) {
		var am = true;
		var hour = date.getHours();
		if(hour > 11) {
			am = false;
			if(hour != 12) hour -= 12;
		}
		var hourString = "";
		if(hour == 0) hourString = "12";
		else if(hour < 10) hourString = "0" + hour;
		else hourString = hour;
		
		var minute = date.getMinutes();
		var minuteString = "";
		if(minute == 0) minuteString = "00";
		else if(minute < 10) minuteString = "0" + minute;
		else minuteString = minute;

		var output = hourString + ":" + minuteString + " ";
		if(am) output += "AM";
		else output += "PM";

		return output;
	}

	document.getElementById("MessageInputField").onkeypress = function(e) {
		if(!e) e = window.event;
		var keyCode = e.keyCode || e.which;
		if(keyCode == '13') {
			PushMessage();
		}
	}
	</script>


	<script src="js/vendor/modernizr-3.6.0.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script>window.jQuery || document.write('<script src="js/vendor/jquery-3.3.1.min.js"><\/script>')</script>
	<script src="js/plugins.js"></script>
	<script src="js/main.js"></script>

	<!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
	<script>
		window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
		ga('create', 'UA-XXXXX-Y', 'auto'); ga('send', 'pageview')
	</script>
	<script src="https://www.google-analytics.com/analytics.js" async defer></script>
</body>

</html>
